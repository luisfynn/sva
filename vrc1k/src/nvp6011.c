/**
 *	@file   nvp6011.c
 *	@brief	
 *	@author luisfynn<@pinetron.com>
 *	@date   2014/10/14 14:39
 */

/* system include */
#include <stdio.h>
#include <string.h>
/* local include */
#include "common.h"
#include "video.h"

#define  I2C_NVP6011_ADDR 	0x31

extern unsigned char I2C1_ByteRead(unsigned char DevAddr, unsigned char Register, unsigned char* pBuff);
extern unsigned char I2C1_ByteWrite(unsigned char DevAddr,unsigned char WriteReg,unsigned char pBuff);

/**************************** 1280X720X30P , 16bit @ 74.25Mhz**************************/
static ROMDATA BYTE AHD_1280X720_30P_16B_74[] =  
{
 // 	 0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
 /*0*/	 0xA0,0x00,0x00,0x80,0x80,0x08,0x00,0x08,0x7E,0x00,0x00,0x80,0x80,0x80,0x01,0x40,
 /*1*/	 0x00,0x01,0x80,0x01,0x86,0x13,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*2*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*3*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*4*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*5*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*6*/	 0x02,0x00,0x00,0x00,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*7*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/**************************** 1280X720X25P , 16bit @ 74.25Mhz**************************/
static ROMDATA BYTE AHD_1280X720_25P_16B_74[] = 
{
 // 	 0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
 /*0*/	 0xA1,0x00,0x00,0x80,0x80,0x08,0x00,0x08,0x7E,0x00,0x00,0x80,0x80,0x80,0x01,0x40,
 /*1*/	 0x00,0x01,0x80,0x01,0x86,0x13,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*2*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*3*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*4*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*5*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*6*/	 0x03,0x00,0x00,0x00,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*7*/	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/**************************** 1280X720X30P , 16bit @ 37.125Mhz**************************/
static ROMDATA BYTE AHD_1280X720_30P_16B_37[] = {
 //      0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
 /*0*/   0xA0,0x00,0x00,0x80,0x80,0x08,0x00,0x08,0x7E,0x00,0x00,0x80,0x80,0x80,0x01,0x40,
 /*1*/   0x00,0x01,0x80,0x01,0x86,0x13,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*2*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*3*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*4*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*5*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*6*/   0x02,0x00,0x00,0x00,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*7*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/**************************** 1280X720X25P , 16bit @ 37.125Mhz**************************/
static ROMDATA BYTE AHD_1280X720_25P_16B_37[] = {
 //      0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
 /*0*/   0xA1,0x00,0x00,0x80,0x80,0x08,0x00,0x08,0x7E,0x00,0x00,0x80,0x80,0x80,0x01,0x40,
 /*1*/   0x00,0x01,0x80,0x01,0x86,0x13,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*2*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*3*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*4*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*5*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*6*/   0x03,0x00,0x00,0x00,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*7*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/**************************** 1280X720X30P , 8bit @ 74.25Mhz**************************/
static ROMDATA BYTE AHD_1280X720_30P_8B_74[] = {
 //      0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
 /*0*/   0xA0,0x00,0x00,0x80,0x80,0x08,0x00,0x08,0x7E,0x00,0x00,0x80,0x80,0x80,0x01,0x40,
 /*1*/   0x00,0x01,0x80,0x01,0x86,0x13,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*2*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*3*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*4*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*5*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*6*/   0x02,0x00,0x10,0x00,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*7*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/**************************** 1280X720X25P , 8bit @ 74.25Mhz**************************/
static ROMDATA BYTE AHD_1280X720_25P_8B_74[] = {
 //      0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
 /*0*/   0xA1,0x00,0x00,0x80,0x80,0x08,0x00,0x08,0x7E,0x00,0x00,0x80,0x80,0x80,0x01,0x40,
 /*1*/   0x00,0x01,0x80,0x01,0x86,0x13,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*2*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*3*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*4*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*5*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*6*/   0x03,0x00,0x10,0x00,0x0A,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 /*7*/   0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

void NVP6011_PLLInit(PNCDEC_INFO pINFO)
{
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0xFF,BANK1);

	if(pINFO->tx.enc_inputclk == ENC_CLK_74M)
		I2C1_ByteWrite(I2C_NVP6011_ADDR,0x4A,0x1F);  //PLL value
	else if(pINFO->tx.enc_inputclk == ENC_CLK_37M)
		I2C1_ByteWrite(I2C_NVP6011_ADDR,0x4A,0x0F);  //PLL value
	else
		I2C1_ByteWrite(I2C_NVP6011_ADDR,0x4A,0x1F);  //PLL value
			
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x4B,0x3A);  //PLL value
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x48,0x61);  //PLL value update
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x48,0x60);  //PLL value locking

//	if(pINFO->tx.enc_input_bus == ENC_INBUS_16B)	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x46,0x07);  
//	else											I2C1_ByteWrite(I2C_NVP6011_ADDR,0x46,0x07);
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x46,0x07);
	
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x4E,0x01);

	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x4F,0x1B);
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x51,0x00);
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x52,0x67);
}

void NVP6011_CommonInit(PNCDEC_INFO pINFO)
{
	BYTE i;

	//DAC init
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0xFF,BANK0);
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x02,0x2F);   //DAC sleep mode 2: on 0: off 

	//PLL & CLKCO
	NVP6011_PLLInit(pINFO);

	I2C1_ByteWrite(I2C_NVP6011_ADDR,0xFF,BANK6);
	if(pINFO->vformat == NTSC)
	{
		if(pINFO->tx.enc_input_bus == ENC_INBUS_16B) 		//AHD
		{
			if(pINFO->tx.enc_inputclk == ENC_CLK_74M) 		
			{
				for(i=0;i<128;i++){
					I2C1_ByteWrite(I2C_NVP6011_ADDR, i,AHD_1280X720_30P_8B_74[i]);
				}
			}
			else 
			{
			}
		}
		else 		//SD(720H)
		{
			if(pINFO->tx.enc_inputclk == ENC_CLK_37M)
			{
			}
			else
			{
			}
		}
	}
	else 		//PAL
	{
		if(pINFO->tx.enc_input_bus == ENC_INBUS_16B) 		//AHD
		{
			if(pINFO->tx.enc_inputclk == ENC_CLK_74M)
			{
				for(i=0;i<128;i++){
					I2C1_ByteWrite(I2C_NVP6011_ADDR, i,AHD_1280X720_25P_8B_74[i]);
				}
			}
			else
			{
			}
		}
		else
		{
			if(pINFO->tx.enc_inputclk == ENC_CLK_37M)
			{
			}
			else
			{
			}
		}
	}
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0xFF,BANK1);
	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x4F,0xFB);  

	printf("\rNVP6011 initialize complete\n");
	
	//test pattern output	
//	I2C1_ByteWrite(I2C_NVP6011_ADDR,0xFF,BANK6);
//	I2C1_ByteWrite(I2C_NVP6011_ADDR,0x19,0x19);
}
